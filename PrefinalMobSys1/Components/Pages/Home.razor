@page "/"
@inject PrefinalMobSys1.Data.InventoryService InventoryService
@inject IJSRuntime JS

<SectionContent SectionName="page-buttons">
    <div id="searchBox" class="input-group header-search" style="display:none;">
        <span class="input-group-text text-warning"><i class="fa fa-search"></i></span>
        <input id="txtSearch" type="text" class="form-control" placeholder="Search" value="@Model?.Search" @onchange="SearchTerm" />
        <span class="input-group-text" onclick="hideSearchBox()"><i class="fa fa-times"></i></span>
    </div>
    <span id="controlBox">
        <CartButton />
        <button class="btn text-warning" onclick="showSearchBox()">
            <i class="fa fa-search"></i>
        </button>
    </span>    
</SectionContent>

<section>
    <h2>Inventory Overview</h2>
    <div style="max-width:600px;">
        <canvas id="inventoryChart"></canvas>
    </div>
</section>


@code {
    private List<string> InventoryNames = new();
    private List<int> InventoryQuantities = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var items = InventoryService.GetAll().ToList();
            InventoryNames = items.Select(i => i.Name).ToList();
            InventoryQuantities = items.Select(i => i.Quantity).ToList();

            var namesJson = System.Text.Json.JsonSerializer.Serialize(InventoryNames);
            var quantitiesJson = System.Text.Json.JsonSerializer.Serialize(InventoryQuantities);

            await JS.InvokeVoidAsync("renderInventoryChart", namesJson, quantitiesJson);
        }
    }
}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="js/jquery.cycle2.js"></script>
<script>
    function showSearchBox(){
        $('#searchBox').show();    
        $('#controlBox').hide();
    }
    function hideSearchBox(){
        $('#searchBox').hide();
        $('#controlBox').show();
    }

    window.renderInventoryChart = function (namesJson, quantitiesJson) {
        var names = JSON.parse(namesJson);
        var quantities = JSON.parse(quantitiesJson);

        var ctx = document.getElementById('inventoryChart').getContext('2d');
        if (window.inventoryChartInstance) {
            window.inventoryChartInstance.destroy();
        }
        window.inventoryChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: names,
                datasets: [{
                    label: 'Quantity',
                    data: quantities,
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { precision:0 }
                    }
                }
            }
        });
    }
</script>
